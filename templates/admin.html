<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MK Chat - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e0e7ff 50%, #f0f9ff 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(203, 213, 225, 0.5);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.15);
        }

        .log-entry {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e0e7ff;
            border-radius: 3px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .badge-info {
            background: rgba(99, 102, 241, 0.1);
            color: #6366f1;
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(99, 102, 241, 0.05);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #1e293b;
            border-bottom: 2px solid rgba(203, 213, 225, 0.5);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
        }

        tr:hover {
            background: rgba(99, 102, 241, 0.02);
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="glass rounded-3xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold mb-2" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Admin Dashboard</h1>
                    <p class="text-gray-600">Monitor and manage MK Chat system</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Last updated</p>
                    <p class="font-semibold" id="last-updated">--:--:--</p>
                    <button onclick="refreshData()" class="btn-primary mt-2">Refresh Data</button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="glass rounded-2xl p-6 stat-card">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-gray-600 text-sm font-medium">Total Users</p>
                    <span class="text-2xl">ðŸ‘¥</span>
                </div>
                <p class="text-3xl font-bold text-gray-800" id="total-users">0</p>
            </div>

            <div class="glass rounded-2xl p-6 stat-card">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-gray-600 text-sm font-medium">Online Users</p>
                    <span class="text-2xl">ðŸŸ¢</span>
                </div>
                <p class="text-3xl font-bold text-green-600" id="online-users">0</p>
            </div>

            <div class="glass rounded-2xl p-6 stat-card">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-gray-600 text-sm font-medium">Total Messages</p>
                    <span class="text-2xl">ðŸ’¬</span>
                </div>
                <p class="text-3xl font-bold text-gray-800" id="total-messages">0</p>
            </div>

            <div class="glass rounded-2xl p-6 stat-card">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-gray-600 text-sm font-medium">Messages Today</p>
                    <span class="text-2xl">ðŸ“Š</span>
                </div>
                <p class="text-3xl font-bold text-indigo-600" id="messages-today">0</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="glass rounded-3xl overflow-hidden">
            <div class="flex border-b border-gray-200">
                <button class="tab-button active" onclick="showTab('logs')">Activity Logs</button>
                <button class="tab-button" onclick="showTab('users')">Users</button>
                <button class="tab-button" onclick="showTab('messages')">Messages</button>
                <button class="tab-button" onclick="showTab('analytics')">Analytics</button>
            </div>

            <!-- Activity Logs Tab -->
            <div id="logs-tab" class="tab-content active p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Live Activity Logs</h2>
                    <button onclick="clearLogs()" class="text-sm text-red-600 hover:text-red-700 font-medium">Clear Logs</button>
                </div>
                <div id="logs-container" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                    <p class="text-gray-500 text-center py-8">No activity logs yet</p>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content p-6">
                <h2 class="text-xl font-bold mb-4">Registered Users</h2>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Messages Sent</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="4" class="text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages-tab" class="tab-content p-6">
                <h2 class="text-xl font-bold mb-4">All Messages</h2>
                <div class="mb-4 flex gap-2">
                    <button onclick="filterMessages('all')" class="btn-filter active" data-filter="all">All</button>
                    <button onclick="filterMessages('group')" class="btn-filter" data-filter="group">Group</button>
                    <button onclick="filterMessages('private')" class="btn-filter" data-filter="private">Private</button>
                </div>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Sender</th>
                                <th>Recipient</th>
                                <th>Message</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody id="messages-table-body">
                            <tr>
                                <td colspan="5" class="text-center text-gray-500">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content p-6">
                <h2 class="text-xl font-bold mb-4">System Analytics</h2>
                <div class="space-y-6">
                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-3">Most Active Users</h3>
                        <div id="active-users-list" class="space-y-2">
                            <p class="text-gray-500 text-sm">No data available</p>
                        </div>
                    </div>

                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-3">Message Distribution</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Group Messages</span>
                                <span class="font-semibold" id="group-msg-count">0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Private Messages</span>
                                <span class="font-semibold" id="private-msg-count">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-xl p-4">
                        <h3 class="font-semibold mb-3">System Health</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Database Status</span>
                                <span class="badge badge-success" id="db-status">Healthy</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">WebSocket Connections</span>
                                <span class="font-semibold" id="ws-connections">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logs = [];
        let allMessages = [];
        let currentFilter = 'all';

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Add log entry
        function addLog(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const log = { type, message, timestamp };
            logs.unshift(log);
            
            if (logs.length > 100) logs.pop();
            
            renderLogs();
        }

        // Render logs
        function renderLogs() {
            const container = document.getElementById('logs-container');
            
            if (logs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity logs yet</p>';
                return;
            }
            
            container.innerHTML = logs.map(log => {
                const badgeClass = log.type === 'info' ? 'badge-info' : 
                                  log.type === 'success' ? 'badge-success' : 'badge-warning';
                return `
                    <div class="log-entry glass rounded-lg p-3 flex items-start gap-3">
                        <span class="badge ${badgeClass}">${log.type.toUpperCase()}</span>
                        <div class="flex-1">
                            <p class="text-sm text-gray-700">${log.message}</p>
                            <p class="text-xs text-gray-500 mt-1">${log.timestamp}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear logs
        function clearLogs() {
            if (confirm('Are you sure you want to clear all logs?')) {
                logs = [];
                renderLogs();
                addLog('info', 'Logs cleared by admin');
            }
        }

        // Refresh data
        async function refreshData() {
            addLog('info', 'Refreshing dashboard data...');
            await loadStats();
            await loadUsers();
            await loadMessages();
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
            addLog('success', 'Dashboard data refreshed successfully');
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                document.getElementById('total-users').textContent = data.total_users;
                document.getElementById('online-users').textContent = data.online_users;
                document.getElementById('total-messages').textContent = data.total_messages;
                document.getElementById('messages-today').textContent = data.messages_today;
                document.getElementById('ws-connections').textContent = data.online_users;
                document.getElementById('group-msg-count').textContent = data.group_messages;
                document.getElementById('private-msg-count').textContent = data.private_messages;
            } catch (error) {
                addLog('warning', 'Failed to load statistics: ' + error.message);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();
                
                const tbody = document.getElementById('users-table-body');
                
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No users found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td><span class="badge ${user.is_online ? 'badge-success' : 'badge-info'}">${user.is_online ? 'Online' : 'Offline'}</span></td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>${user.message_count}</td>
                    </tr>
                `).join('');

                // Update active users list
                const activeUsers = users
                    .sort((a, b) => b.message_count - a.message_count)
                    .slice(0, 5);
                
                document.getElementById('active-users-list').innerHTML = activeUsers.map((user, i) => `
                    <div class="flex justify-between items-center">
                        <span class="text-sm">${i + 1}. ${user.username}</span>
                        <span class="badge badge-info">${user.message_count} msgs</span>
                    </div>
                `).join('');
                
            } catch (error) {
                addLog('warning', 'Failed to load users: ' + error.message);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const response = await fetch('/api/admin/messages');
                allMessages = await response.json();
                filterMessages(currentFilter);
            } catch (error) {
                addLog('warning', 'Failed to load messages: ' + error.message);
            }
        }

        // Filter messages
        function filterMessages(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) btn.classList.add('active');
            });
            
            let filtered = allMessages;
            if (filter === 'group') {
                filtered = allMessages.filter(m => m.recipient === 'GROUP');
            } else if (filter === 'private') {
                filtered = allMessages.filter(m => m.recipient !== 'GROUP');
            }
            
            const tbody = document.getElementById('messages-table-body');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500">No messages found</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.map(msg => `
                <tr>
                    <td class="text-xs">${new Date(msg.timestamp).toLocaleString()}</td>
                    <td><strong>${msg.sender}</strong></td>
                    <td>${msg.recipient}</td>
                    <td class="max-w-xs truncate">${msg.message}</td>
                    <td><span class="badge ${msg.recipient === 'GROUP' ? 'badge-success' : 'badge-info'}">${msg.recipient === 'GROUP' ? 'Group' : 'Private'}</span></td>
                </tr>
            `).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('success', 'Admin dashboard loaded successfully');
            refreshData();
            
            // Auto-refresh every 10 seconds
            setInterval(refreshData, 10000);
        });

        // Add custom button styles
        const style = document.createElement('style');
        style.textContent = `
            .btn-filter {
                padding: 8px 16px;
                border-radius: 8px;
                border: 1px solid rgba(203, 213, 225, 0.5);
                background: rgba(255, 255, 255, 0.7);
                color: #64748b;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            .btn-filter:hover {
                background: rgba(99, 102, 241, 0.1);
                border-color: #6366f1;
            }
            .btn-filter.active {
                background: linear-gradient(135deg, #6366f1, #8b5cf6);
                color: white;
                border-color: transparent;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>